# 4. ユーザーの入力を伴うカードの作成と送信

Adaptive Cards の大きな特徴の一つに、『ユーザーがアクションを行える』ということがあります。これを利用して簡易なアンケートフォームを作成したり、ダイアログを作成することが可能です。

本章では、Teams を対象としてユーザーの入力を伴うカードの送信と、フロー上での入力結果取得について解説します。

§4-3, 4-4 では、Outlook を利用した場合の入力フォーム送信を紹介しますが、Outlook から入力情報を受け取る場合には有償プランでのみ利用可能な HTTP コネクターが必要となりますのでご注意ください。

## 4-1. Teams 向けカードの作成と送信
Teams に対してカードを送信する場合には、"Teams ユーザー"に対する送信と "Teams チャンネル" に対する送信の2パターンがあります。

ここではテストのために、Teams ユーザー (自分) にカードを送信してみます。 Teams チャンネルに送信する場合の手続きも同様ですが、以下の注意事項があります。

>**注意事項**
>
>Teams チャンネルにカードを送信した場合、アクションはいずれか1人のメンバーからのみ受け付けられます。
これはカード送信、応答待機のアクション「アダプティブカードを Teams チャネルに投稿して応答を待機」が、チャンネルの誰かが回答を送信した時点で先に進んでしまうためです。
Power Automate の枠内で直接的な回避方法はありませんので、複数のユーザーに送信する場合の補足を §4-3 で解説します。

ユーザーの入力を伴うカードの送信は「アダプティブカードを Teams ユーザーに投稿して応答を待機」を利用します。

シンプルなカード送信のアクションと明らかに異なり、「アダプティブカードの作成」ボタンがアクションに表示されていることがわかります。
このボタンをクリックすると Power Automate 組み込みのAdaptive Cards デザイナーが表示されます。

表示するとデフォルトで入力パーツを含むカードが表示されます。
§2 で見たように、入力パーツには固有のIdの設定が必要でした。
サンプルではこれが

- 名前 : myName
- 電子メール : myEmail
- 電話番号 : myTel


とIdが対応していることが分かります。

組み込みのデザイナーを利用しているため、カードのJSONをコピー&ペーストする必要はありません。「カードの保存」をクリックし、送信するカードを決定しましょう。

他の設定内容、受信者には自分のメールアドレスを、更新メッセージには 『回答ありがとうございました』 のようなメッセージを含めます。
「カードの更新が必要」は選択肢ですが、今は『はい』を選んでください。

以上で設定は終了です。フローのテストを実行してみましょう。

入力の前に、受信したカードをPCのWebブラウザー、Teams アプリ、モバイルの Teams アプリで表示してみてください。
横幅以外にも入力・表示が少し異なっている点に気付くと思います。

主要な入力パーツを追加したカードで、クライアントでの表示差異をまとめた動画がありますので、参考にしてみてください。


## 4-2. 入力情報の取得と変換
送信したカードに入力された情報は、同じフローの中で利用することができます。
例えばSharePointのリストにアイテムを作成したり、回答結果をもとにメール送信や次の承認ステップに遷移したりという具合です。
ここでは例として、入力結果を自分にメール送信してみます。

「アダプティブカードを Teams ユーザーに投稿して応答を待機」アクションの次のステップに「メールの送信 (V2)」アクションを追加します。
宛先は自分のメールアドレス、件名は『入力確認』などとし、本文の入力ボックスにフォーカスします。

入力ボックス右上に、三本線に雷マークのアイコンが表示されていますので、これをクリックして動的な値 (= 先行ステップで得られる結果)を利用します。

下図のような表示になるよう、文字を入力し、動的な値を選択して、テストを実行しましょう。

結果を見ると確かに入力値が反映されていることが分かります。
SharePoint リスト等のデータソースに保存する場合も同様です。

### 入力結果の型変換
カードデザイナーで入力をInput.Numberで作った場合と、複数選択の場合を見ていきます。
ここではmyNumberとmultiChoiceがそれぞれ、Input.Numberの結果、Input.ChoiceSetの結果です。

数値であっても結果は文字列として、複数選択結果は本来配列のはずですが、結果はカンマで結合された文字列として出力されていることが分かります。

入力された値を数値型または配列にするために Power Automate で用意された関数を利用します。
全ての関数の詳細については [公式のDocs]() を参照してください。

文字列→数値 (整数)であれば、float (int)を利用します。
単純な配列への変換であればこの場合には splitを利用する事で、カンマ区切りの文字列から配列が生成されます。

```
float()
int()
split('',',')
```
これらの式追加によって、本来期待される型で結果が得られました。後続ステップではこの処理を施してデータを利用しましょう。


## 4-3. 補足事項
入力を伴うカードの送信アクションは既定では30日入力を待ち続けてしまいます。
このような長期間走るフローを抑止するために、入力を待つアクションではカスタムタイムアウトを設定することが有効です。



§4-2では、単一ユーザーに対するカード送信を紹介しました。先述のとおり、Teams チャンネルにカードを送信しても1人が回答した時点でフローが先に進んでしまうため、複数人からの回答を受け付けることができません。

これを回避するためにはユーザーリストをフローの中でもち、それらのユーザーに個別に、Apply to eachのループ処理でカードを送信する必要があります。
既定ではApply to eachは並列化されませんので、明示的に並列化の多重度を指定してあげましょう。

ただし、Apply to eachの最大並列化多重度は50であることに注意してください。 50人を超えるようなユーザーを対象としてカードを送信する場合には、必ず51人目以降で送信待ちが発生します。
このため、適用先としては少人数のチーム程度とするのが望ましいと考えられます。

## 4-4. Outlook向けカードの作成と送信
この節では Outlook (メール) でユーザーが入力可能なカードを作成・送信する方法を紹介します。
Outlook では入力を待機するようなアクションが提供されていない (そもそもAction.Submitがサポート外) であるため、メールのカード上からHTTPリクエストを行うアクション、Action.Http を利用する必要があります。

HTTPのリクエスト先として、Power Automateであれば、「HTTP要求の受信時」トリガーが考えられますが、このトリガーはPremiumライセンスが必要であることに注意してください。

また、Azureのリソースが利用できる場合にはLogic Appsで待ち受けを行い、データ登録をすることも検討してください。

### 準備 : 待ち受け側のフロー作成
カード作成時にリクエスト送信先のURLが必要になるため、先に「HTTP要求の受信時」トリガーのフローを作成しておきます。

スキーマにはこのあと設定するカードから送信されるデータに合わせて、以下のように設定します。

```
{
  "type": "object",
  "properties": {
    "myName": {
      "type": "string"
    },
    "myNumber": {
      "type": "integer"
    },
    "multiChoice": {
      "type": "string"
    }
  }
}
```

トリガーの次に「応答」アクションを追加してステータス200を返却するようにします。

Outlook でもデータ送信後のカード更新 (Teamsでの『ありがとうございました』メッセージ) が可能です。
これを行うためには以下のようにヘッダー情報を設定し、ボディに簡単なカードを設定します。

**ヘッダー**
|Key|Value|
|---|---|
|CARD-UPDATE-IN-BODY|true|

**本文**
```
{
  "type": "AdaptiveCard",
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "version": "1.0",
  "body": [
    {
      "type": "TextBlock",
      "text": "Thank you"
    }
  ]
}
```


以上で待ち受け側のフローは作成完了です。必要に応じてデータ登録のステップを間に挿入してください。

### Outlook 向けカード作成
前述のとおり、Outlook ではAction.Submitが利用できず、Action.Httpを利用してデータ送信を行います。
この違いを反映したカードを作成するために、Adaptive Cards デザイナー画面ではまず「Select host app」のドロップダウンで「Outlook Actionable Messages」を選択しましょう。

Teamsで利用した場合と同様にテキスト入力、数値入力、複数選択可能な選択肢を用意して、最後にAction.Httpを追加します。

Action.Httpの設定を以下のようにします。

|設定項目|設定値|
|---|---|
|Title|送信|
|Method|POST|
|Url|ここにフローのURL|
|Body|{"myName":"{{myName.value}}","myNumber":{{myNumber.value}},"multiChoice":"{{multiChoice.value}}"}|

**HTTP headers**
|Key|Value|
|---|---|
|Content-Type|application/json|
|Authorization||

ここで、Bodyに設定しているJSONは、```{{入力パーツのId.value}}``` の形式で入力データにアクセスしています。
文字列であれば {{...}} の前後に" (ダブルクォーテーション)をつけてください。

最終的にはカードのJSONが以下のようになることを確認してください。
```
{
  "type": "AdaptiveCard",
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "version": "1.0",
  "body": [
    {
      "type": "TextBlock",
      "text": "名前を入力してください"
    },
    {
      "type": "Input.Text",
      "id": "myName"
    },
    {
      "type": "TextBlock",
      "text": "数値を入力してください"
    },
    {
      "type": "Input.Number",
      "id": "myNumber"
    },
    {
      "type": "TextBlock",
      "text": "複数選択"
    },
    {
      "type": "Input.ChoiceSet",
      "choices": [
        {
          "title": "Choice 1",
          "value": "Choice 1"
        },
        {
          "title": "Choice 2",
          "value": "Choice 2"
        }
      ],
      "id": "multiChoice",
      "isMultiSelect": true
    }
  ],
  "actions": [
    {
      "type": "Action.Http",
      "title": "送信",
      "method": "POST",
      "body": "{\"myName\":\"{{myName.value}}\", \"myNumber\":{{myNumber.value}}, \"multiChoice\":\"{{multiChoice.value}}\"}",
      "headers": [
        {
          "name": "Content-Type",
          "value": "application/json"
        },
        {
          "name": "Authorization",
          "value": ""
        }
      ],
      "url": "ここにフローのURL"
    }
  ]
}
```

これでカードのJSONは完成です。

Power Automateの画面に戻り、インスタント フローの作成を開始します。

トリガーの直後に「作成」アクションを挿入し、上記のJSONをペーストします。
シンプルなカードの送信時と同様に、以下の本文でメール送信アクションを追加します。

実際にメールを送信してテストしてみましょう。

メール受信後、送信ボタン押下時に401エラーが発生する場合には、カードのAction.Httpのヘッダーに
```
{
    "name": "Authorization",
    "value": ""
}
```
が含まれているかを確認しましょう。

400が発生する場合には、高い確率で送信データのJSONスキーマに誤りがあります。
特にプロパティ名とデータ型を再度確認してください。

以上で Outlook からのカード送信、入力データの受信は完了です。

## 課題

## 本章のまとめ

