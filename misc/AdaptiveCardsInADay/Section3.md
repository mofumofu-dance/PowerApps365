# 3. Microsoft Teams, Outlook へのカード送信

本章では、Power Automateを利用して Microsoft Teams, Outlook に対して Adaptive Cards を送信する方法を解説します。

なお、カード送信には Power Automate の"for Office 365" プラン以上, Exchange Online, Microsoft Teams が利用可能であるということを前提としています。

## 3-0. 準備 : 試験的機能の有効化、アクションのリネーム
初めに準備として、Power Automate の試験的な機能を有効にします。
この設定を有効にすることによって、Teams 向けにユーザー入力を含むカードを作成する際、Power Automate 組み込みのデザイナーを利用することが可能になります。

Power Automate の画面、右上に表示されている歯車マークをクリックし、「すべての Power Automate 設定を表示」を選択します。
表示されるダイアログのうち、「試験的な機能」のトグルをオンにし、「保存」をクリックしてください。 
## 3-1. シンプルなカードのTeamsへの送信
まず Adaptive Cards デザイナーで作成したシンプルなカードを Teams に送信することを考えます。

ここで、「シンプルなカード」とは、文字列、URL、選択肢がすべて埋め込みになっていて、かつユーザーの入力、Action.Submit, Action.Http のアクションを含まないカードを指しています。

Power Automate (https://flow.microsoft.com) にアクセスし、「+ 作成」でフローの作成を開始します。
初めはテストしやすいように、「インスタント フロー」> 「手動でフローをトリガーします」からフローを作成します。

※テストが終わった後は必要に応じて、作成したフローのトリガーを変更することで定期的にカードを送信するスケジュールフローに変更することが可能です。

「＋新しいステップ」をクリックし、Microsoft Teams のコネクターを選択します。
表示されたアクションの中から「独自のアダプティブカードをチームのユーザーに送信」を選択します。

受信者に自分のメールアドレスを指定し、メッセージに Adaptive Cards デザイナーからコピーしてきたJSONを貼り付けます。

フローを保存し、画面右上の「テスト」から、テストを実行しましょう。
Teams (Web, アプリ) を起動し表示を確認しましょう。デザイナーでのプレビューと比較して、多少横幅が小さいですが、基本的には同じカードが表示されていることが分かります。

可能であればiOS/Adnroid版の Teams アプリでも表示を確認してください。
ここで送信したカードでは、ユーザーの入力やアクションを含まないため、表示はプラットフォームによらず、同一であることが見て取れます。

## 3-2. シンプルなカードのOutlookへの送信

次に同じカードをOutlookに送信する場合を見ていきます。

再び新しいフローをモバイルフローボタンのトリガーで作成します。

Outlookではコネクターのアクションとして Adaptive Cards の送信は提供されていませんが、カードのJSONをフロー上で定義し、特定のフォーマットに従ってメールを作成することでメールでのカード送信が可能になります。

「新しいステップ」を選択する際に表示された「組み込み」タブから「データ操作」> 「作成」のアクションを追加します。
「作成」アクションの入力に、カードのJSONを貼り付けます。

新しいステップを追加し、「Office 365 Outlook」のコネクターから、「メールの送信 (V2)」を選択します。
宛先には自分のメールアドレス、件名を設定します。

Adaptive Cards の送信では本文のフォーマットが重要です。
</> のアイコンをクリックし、コード表示に切り替えた状態で以下のHTMLを貼り付けます。

```
<html>
<head>
<script type = 'application/adaptivecard+json'>@{outputs('作成')}
</script>
</head>
<body>　</body>
</html>
```
貼り付けを行うと下図のように```@{outputs('作成')}```部分が置き換えられていることが分かります。
もし置き換えがうまくいかない場合には一度@{...}部分を削除し、動的なコンテンツから作成アクションの結果を挿入してください。

>**注意事項**
>
>日本語のカードを取り扱う場合には<body>の中に何らかの日本語を含める必要がありました。
ここでは全角スペースを入れていますが、『よろしくお願いします』 のようなメッセージでもいいかもしれません。。


**図**

フローを保存し、画面右上の「テスト」から、テストを実行しましょう。Teamsの場合と比べて表示がどのように変化しているか確認してください。

§1でも触れたように、Adaptive Cards デザイナーでは表示するサービスを切り替えてプレビューすることができますが、Outlookの場合にはTeamsに比べ横幅の広いカードを送信することが可能です。
ただし、モバイルのOutlookアプリで表示されることを考慮する場合には、横幅が狭くなることを考慮して、テキストには「Wrap」属性をつけることを忘れないようにしましょう。

## 3-3. 課題

## 3-4. 本章のまとめ



